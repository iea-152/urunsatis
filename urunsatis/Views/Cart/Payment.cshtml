@{
    ViewData["Title"] = "Ödeme Yöntemi";
    decimal toplamTutar = ViewBag.ToplamTutar ?? 0;
}

<div class="content-header">
    <div class="container">
        <h1 class="m-0 text-dark">Güvenli Ödeme</h1>
    </div>
</div>

<section class="content">
    <div class="container">
        <form asp-action="ProcessPayment" method="post" id="paymentForm">
            <div class="row">

                <div class="col-md-7">
                    <div class="card card-primary card-outline">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-wallet mr-1"></i> Ödeme Seçenekleri
                            </h3>
                        </div>
                        <div class="card-body">

                            <div class="form-group border rounded p-3 mb-3 bg-light">
                                <div class="custom-control custom-radio">
                                    <input class="custom-control-input" type="radio" id="creditCard" name="paymentMethod" value="Kredi Kartı" checked>
                                    <label for="creditCard" class="custom-control-label font-weight-bold">
                                        Kredi / Banka Kartı
                                    </label>
                                    <div class="mt-2 text-muted small">
                                        <i class="fab fa-cc-visa fa-2x mr-1"></i>
                                        <i class="fab fa-cc-mastercard fa-2x mr-1"></i>
                                        <i class="fab fa-cc-amex fa-2x"></i>
                                    </div>

                                    <div id="creditCardDetails" class="mt-3 p-3 bg-white rounded border shadow-sm">

                                        <div class="form-group">
                                            <label class="small">Kart Üzerindeki İsim</label>
                                            <input type="text" class="form-control form-control-sm text-uppercase" placeholder="AD SOYAD">
                                        </div>

                                        <div class="form-group">
                                            <label class="small">Kart Numarası</label>
                                            <div class="input-group input-group-sm">
                                                <div class="input-group-prepend">
                                                    <span class="input-group-text"><i class="fas fa-credit-card"></i></span>
                                                </div>
                                                <input type="text" class="form-control" placeholder="0000 0000 0000 0000" maxlength="19" id="cardNumberInput">
                                            </div>
                                        </div>

                                        <div class="row">
                                            <div class="col-6">
                                                <label class="small">Son Kullanma (AA/YY)</label>
                                                <input type="text" class="form-control form-control-sm" placeholder="MM/YY" maxlength="5">
                                            </div>
                                            <div class="col-6">
                                                <label class="small">CVC / CVV</label>
                                                <input type="text" class="form-control form-control-sm" placeholder="123" maxlength="3">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="form-group border rounded p-3 mb-3">
                                <div class="custom-control custom-radio">
                                    <input class="custom-control-input" type="radio" id="bankTransfer" name="paymentMethod" value="Havale/EFT">
                                    <label for="bankTransfer" class="custom-control-label font-weight-bold">
                                        Havale / EFT
                                    </label>
                                </div>
                            </div>

                            <div class="form-group border rounded p-3">
                                <div class="custom-control custom-radio">
                                    <input class="custom-control-input" type="radio" id="cashOnDelivery" name="paymentMethod" value="Kapıda Ödeme">
                                    <label for="cashOnDelivery" class="custom-control-label font-weight-bold">
                                        Kapıda Ödeme
                                    </label>
                                    <span class="badge badge-warning float-right">+20₺</span>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>

                <div class="col-md-5">
                    <div class="card card-warning">
                        <div class="card-header">
                            <h3 class="card-title font-weight-bold">Sipariş Özeti</h3>
                        </div>
                        <div class="card-body">
                            <div class="d-flex justify-content-between mb-2">
                                <span>Ürünler Toplamı:</span>
                                <span>@toplamTutar.ToString("c")</span>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span>Kargo:</span>
                                <span class="text-success font-weight-bold">Ücretsiz</span>
                            </div>
                            <div class="d-flex justify-content-between mb-2" id="kapidaOdemeRow" style="display:none;">
                                <span>Kapıda Ödeme Farkı:</span>
                                <span>20,00 ₺</span>
                            </div>
                            <hr>
                            <div class="d-flex justify-content-between font-weight-bold" style="font-size: 1.3rem;">
                                <span>TOPLAM:</span>
                                <span class="text-primary" id="finalTotal">@toplamTutar.ToString("c")</span>
                            </div>
                        </div>
                        <div class="card-footer">
                            <button type="submit" class="btn btn-success btn-lg btn-block shadow hover-effect">
                                <i class="fas fa-check-circle mr-2"></i> Ödemeyi Onayla
                            </button>
                            <a asp-action="Index" class="btn btn-link btn-block text-muted btn-sm mt-2">
                                <i class="fas fa-arrow-left"></i> Sepete Dön
                            </a>
                        </div>
                    </div>

                    <div class="text-center mt-3 text-muted small">
                        <i class="fas fa-lock text-success"></i> 256-Bit SSL ile güvenli alışveriş.
                    </div>
                </div>
            </div>
        </form>
    </div>
</section>

<script>
    // Sayfa Yüklendiğinde
    document.addEventListener("DOMContentLoaded", function() {

        var radioButtons = document.getElementsByName("paymentMethod");
        var creditCardDetails = document.getElementById("creditCardDetails");
        var kapidaOdemeRow = document.getElementById("kapidaOdemeRow");
        var finalTotalSpan = document.getElementById("finalTotal");

        // C# tarafındaki tutarı JavaScript'e aktar (Virgül yerine nokta kullanmak gerekebilir)
        // Ancak basitlik olsun diye sadece görseli değiştiriyoruz.
        var baseTotal = "@toplamTutar.ToString("c")";

        // Radyo butonları değişince çalışacak kod
        for(var i = 0; i < radioButtons.length; i++) {
            radioButtons[i].addEventListener('change', function() {

                // 1. Kredi Kartı Detayını Göster/Gizle
                if(this.id === 'creditCard') {
                    creditCardDetails.style.display = 'block';
                } else {
                    creditCardDetails.style.display = 'none';
                }

                // 2. Kapıda Ödeme Farkını Göster/Gizle
                if(this.id === 'cashOnDelivery') {
                    kapidaOdemeRow.style.display = 'flex';
                    // Buraya basit bir JS ile +20TL ekleme yapılabilir ama
                    // şimdilik sadece "Fark var" diye gösteriyoruz.
                } else {
                    kapidaOdemeRow.style.display = 'none';
                }
            });
        }

        // Kart Numarası Otomatik Boşluk (Formatlama)
        var cardInput = document.getElementById("cardNumberInput");
        cardInput.addEventListener('input', function (e) {
            var target = e.target;
            var position = target.selectionEnd;
            var length = target.value.length;

            target.value = target.value.replace(/[^\d]/g, '').replace(/(.{4})/g, '$1 ').trim();
            target.selectionEnd = position += ((target.value.charAt(position - 1) === ' ' && target.value.charAt(length - 1) === ' ' && length !== target.value.length) ? 1 : 0);
        });
    });
</script>